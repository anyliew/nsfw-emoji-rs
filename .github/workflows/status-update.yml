name: Weekly Status Update

on:
  schedule:
    - cron: '0 10 * * 1'  # æ¯å‘¨ä¸€ä¸Šåˆ10ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  status-update:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Update Stale Issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 50
            });
            
            const now = new Date();
            let updatedCount = 0;
            
            for (const issue of issues) {
              // è·³è¿‡PR
              if (issue.pull_request) continue;
              
              const lastUpdated = new Date(issue.updated_at);
              const daysSinceUpdate = Math.floor((now - lastUpdated) / (1000 * 60 * 60 * 24));
              const daysSinceCreated = Math.floor((now - new Date(issue.created_at)) / (1000 * 60 * 60 * 24));
              
              const hasStaleLabel = issue.labels.some(label => label.name === 'stale');
              const hasNeedsResponseLabel = issue.labels.some(label => label.name === 'needs-response');
              const isPriorityHigh = issue.labels.some(label => label.name === 'priority/high');
              
              // 7å¤©æ— æ›´æ–°ä¸”ä¸æ˜¯é«˜ä¼˜å…ˆçº§çš„issue
              if (daysSinceUpdate >= 7 && !hasStaleLabel && !isPriorityHigh) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ğŸ‘‹ è¿™ä¸ªissueå·²ç»ä¸€å‘¨æ²¡æœ‰æ›´æ–°äº†ã€‚
                  
                  å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›æ›´å¤šä¿¡æ¯ï¼š
                  - æ˜¯å¦è¿˜èƒ½å¤ç°ï¼Ÿ
                  - æœ‰æ²¡æœ‰æ–°çš„é”™è¯¯ä¿¡æ¯ï¼Ÿ
                  - æ˜¯å¦å°è¯•äº†å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Ÿ
                  
                  å¦‚æœé—®é¢˜å·²è§£å†³ï¼Œæ¬¢è¿å…³é—­æ­¤issueã€‚å¦‚æœ30å¤©å†…æ²¡æœ‰å“åº”ï¼Œæ­¤issueå°†è¢«è‡ªåŠ¨å…³é—­ã€‚`
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });
                
                updatedCount++;
              }
              
              // 30å¤©æ— æ›´æ–°çš„stale issueè‡ªåŠ¨å…³é—­
              else if (daysSinceUpdate >= 30 && hasStaleLabel) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ğŸ¤– æ­¤issueå› é•¿æœŸæ— å“åº”è¢«è‡ªåŠ¨å…³é—­ã€‚
                  
                  å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·åˆ›å»ºæ–°çš„issueå¹¶æä¾›è¯¦ç»†ä¿¡æ¯ã€‚æ„Ÿè°¢æ‚¨çš„ç†è§£ï¼`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'not_planned'
                });
                
                updatedCount++;
              }
              
              // éœ€è¦å›å¤çš„issueæé†’
              else if (daysSinceUpdate >= 3 && hasNeedsResponseLabel) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `â° æé†’ï¼šæ­¤issueç­‰å¾…å›å¤å·²è¶…è¿‡3å¤©ã€‚
                  
                  æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ï¼Œæ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ï¼`
                });
                
                updatedCount++;
              }
            }
            
            console.log(`Updated ${updatedCount} issues`);
      
      - name: Generate Weekly Report
        uses: actions/github-script@v7
        with:
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const startDate = oneWeekAgo.toISOString().split('T')[0];
            const endDate = new Date().toISOString().split('T')[0];
            
            // è·å–æ•°æ®
            const [newIssues, newPRs, closedIssues] = await Promise.all([
              github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:issue created:>=${startDate}`,
                sort: 'created',
                order: 'desc'
              }),
              github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:pr created:>=${startDate}`,
                sort: 'created',
                order: 'desc'
              }),
              github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:issue closed:>=${startDate}`,
                sort: 'updated',
                order: 'desc'
              })
            ]);
            
            // æ„å»ºissueåˆ—è¡¨
            let issueList = 'æœ¬å‘¨æš‚æ— æ–°issue';
            if (newIssues.data.items.length > 0) {
              issueList = newIssues.data.items.slice(0, 5).map(issue => {
                const labels = issue.labels.map(l => l.name).join(', ') || 'æœªåˆ†ç±»';
                return `- [${issue.title}](${issue.html_url}) - ${labels}`;
              }).join('\n');
            }
            
            const report = `ğŸ“Š **æœ¬å‘¨æ´»åŠ¨æŠ¥å‘Š** (${startDate} ~ ${endDate})
            
            ## ğŸ“ˆ ç»Ÿè®¡æ•°æ®
            - ğŸ¯ æ–°å¢ Issues: ${newIssues.data.total_count}
            - ğŸ”€ æ–°å¢ PRs: ${newPRs.data.total_count}  
            - âœ… å…³é—­ Issues: ${closedIssues.data.total_count}
            
            ## ğŸ·ï¸ Issue åˆ†ç±»
            ${issueList}
            
            æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…çš„å‚ä¸ï¼ ğŸ™`;
            
            console.log(report);